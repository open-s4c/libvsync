name: libvsync verification
on: [push, pull_request]
jobs:
  Run-Checks:
    runs-on: ubuntu-latest
    container: ghcr.io/open-s4c/vsyncer-ci:sha-b2ec5f174362e5ff3a50aa235b323e7cda4ca23e
    strategy:
      matrix:
        test-dir: [ {p: "test", c: "spinlock"}, {p: "test", c: "quack"}, {p: "verify", c: "unbounded_queue"}, {p: "verify", c: "listset"} ]
    steps:
      - name: Print vsyncer version
        run: vsyncer version
      - name: Check out repository code
        uses: actions/checkout@v4
      - name: Configure Verification
        run: cmake -S. -Bbuild -DVSYNCER_CHECK=ON
      - name: Build Verification Clients for ${{ matrix.test-dir }}
        run: cmake --build build/${{ matrix.test-dir.p }}/${{ matrix.test-dir.c }}
      - name: Run Verification
        run: ctest --test-dir build/${{ matrix.test-dir.p }}/${{ matrix.test-dir.c }} -R check* --output-on-failure
      - name: Upload vsyncer report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: check-report-${{ matrix.test-dir.c }}
          path: build/logs
